//@version=6
indicator("God's Plan 7.1", overlay=true)

// === INPUTS ===
emaLen = input.int(9, title="EMA Length")

// === CORE INDICATORS ===
ema9 = ta.ema(close, emaLen)
plot(ema9, color=color.blue, title="9 EMA")

isNewSession = timeframe.change("D")
[vwapLine, _, _] = ta.vwap(hlc3, isNewSession, 1)
plot(vwapLine, color=color.orange, title="VWAP")

// === TOP BOTTOM STATE (mock logic) ===
// Replace with real Top Bottom logic if available
topBottomState = close > close[1] ? 1 : close < close[1] ? -1 : 0

// === PRIMARY ENTRY SIGNALS ===
buySignal = ta.crossover(ema9, vwapLine) and topBottomState > 0
sellSignal = ta.crossunder(ema9, vwapLine) and topBottomState < 0

// === TRACK LAST ENTRY BAR ===
var int lastBuyBar = na
var int lastSellBar = na
if buySignal
    lastBuyBar := bar_index
if sellSignal
    lastSellBar := bar_index

// === CONTINUATION SIGNALS ===
pullbackBuy = low < ema9 and close > ema9
momentumBuy = high > high[1]
buyContCandidate = pullbackBuy and close > vwapLine and topBottomState > 0 and momentumBuy
validBuyCont = not na(lastBuyBar) and bar_index > lastBuyBar + 5 and bar_index < lastBuyBar + 25 and buyContCandidate

pullbackSell = high > ema9 and close < ema9
momentumSell = low < low[1]
sellContCandidate = pullbackSell and close < vwapLine and topBottomState < 0 and momentumSell
validSellCont = not na(lastSellBar) and bar_index > lastSellBar + 5 and bar_index < lastSellBar + 25 and sellContCandidate

// === PLOT SIGNALS ===
plotshape(buySignal, title="Buy", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plotshape(sellSignal, title="Sell", location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL")
plotshape(validBuyCont, title="Cont Buy", location=location.belowbar, style=shape.labelup, text="C", size=size.tiny, color=color.teal)
plotshape(validSellCont, title="Cont Sell", location=location.abovebar, style=shape.labeldown, text="C", size=size.tiny, color=color.orange)

// === ALERT CONDITIONS ===
alertcondition(buySignal, title="Buy Alert", message="God's Plan 7 - BUY Signal")
alertcondition(sellSignal, title="Sell Alert", message="God's Plan 7 - SELL Signal")
alertcondition(validBuyCont, title="Buy Continuation Alert", message="God's Plan 7 - CONTINUATION BUY Signal")
alertcondition(validSellCont, title="Sell Continuation Alert", message="God's Plan 7 - CONTINUATION SELL Signal")
