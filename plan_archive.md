# EZAlgoTrader.pine Overhaul and Feature Expansion Plan - ARCHIVED

## Notes
- User is planning a major overhaul to add a directional bias feature.
- Directional bias can be based on several trend-following indicators, with user-selectable confluence logic (checkboxes for each indicator, combine if multiple are checked).
- User wants the option to use a buy/sell indicator as directional bias.
- Brainstorming is needed for handling sharp reversals and avoiding trades that immediately go against the position.
- Trailing stop logic is now fully understood: current system aggressively locks profits using a 10% offset buffer ("Smart Profit Locker").
- User wants to be able to adjust the offset (with 0.05 step granularity) and have a UI input for this.
- The Smart Profit Locker now covers both aggressive (small offset) and traditional (100% offset) trailing stop behaviors; the separate Traditional Trailing Stop has been removed as redundant.
- Additional trend indicators (e.g., MA ribbon) and user-pluggable options are desired.
- Any new exit methods or ideas are welcome for consideration.
- Previous technical debt cleanup (removal of legacy variables, Smart Filter, Fibonacci exits, logger integration) is complete.
- Legacy trailing stop variable references (trailType, trailVal) removed; code now uses smartProfitType/smartProfitVal.
- iLogger removed due to persistent array errors at bar 0; replaced with a native, label-based debug system using Pine Script labels for all debug output (no external dependencies, no array errors).
- Debug logger initialization fixed to prevent array errors at bar 0; logger now safely initializes only on first bar when enabled (Pine Script v6 best practice).
- User wants to integrate the Relative Bandwidth Filter as a selectable, fully-configurable directional bias filter in EZAlgoTrader.
- All options from the original indicator must be preserved, but the panel UI should be compact and use multi-column layout to avoid clutter.
- Each filter (including Relative Bandwidth Filter) must be independently activatable/deactivatable for testing.
- RBW filter logic and variables now fully integrated in EZAlgoTrader; output is used for directional bias in entry logic. Debug logging and all original options preserved. Ready for testing.
- RBW variable ordering and duplicate definition errors resolved; directional bias logic now correctly applied after RBW calculation.
- All RBW variables are now properly declared and all identifier/namespace errors resolved (replaced ta. namespace functions with built-in equivalents for Pine Script v6 compatibility). RBW filter is fully functional and ready for production testing.
- All ta. namespace issues in the RBW filter section have been resolved in small, targeted code chunks. RBW filter logic is now confirmed production-ready and no further namespace fixes are needed in the file.
- RBW filter logic bug (entry signal assignment order) found and fixed; RBW directional bias is now correctly applied to entries.
- Trailing stop logic (Smart Stop and Traditional Trailing Stop) is now confirmed to be working identically with the same settings; the 91% win rate is legitimate and not due to a bug. Preserve this configuration as a baseline before making further changes.
- All combo backtesting code (including multi-signal tables and recommendations) has been removed for code bloat reduction.
- The missing primaryLongSig/primaryShortSig logic has been fixed: enabled signals are now correctly combined and connected to entry logic. The RBW filter and all confluence logic now operate as intended.
- User has provided three Pine Script v6 trend indicators (Hull Suite, Quadrant/Nadaraya-Watson, SuperTrend) in a Trend folder and wants to add them as selectable, modular directional bias filters with independent toggles and confluence logic (Any/Majority/All). Implementation strategy and design discussion needed before coding.
- Implementation plan agreed: embed core logic for each filter directly in EZAlgoTrader, starting with Hull Suite, then SuperTrend, then Quadrant. UI will allow independent toggles and confluence mode selection (Any/Majority/All). Visual markers and parameter exposure to be considered as part of implementation.
- Modular directional bias filter system (Hull Suite, SuperTrend, Quadrant, confluence logic, debug logging) fully implemented and tested for syntax/type errors. All function definitions are now at global scope (Pine Script v6 compliant). Ready for user testing. Visual plotting/markers are optional and not yet implemented.
- ZigZag Tails and MultiTimeFrame ZigZag identified as advanced trend filters for possible integration (user likes Trendoscope's work and wants to add these as selectable bias filters).
- Multi-Timeframe ZigZag filter, trend-riding overlay system, and adaptive/impulsive exit system are now fully implemented in EZAlgoTrader with UI configurability and tooltips. MTF ZigZag uses confirmed bars only. Adaptive exits and trend-riding logic are integrated with debug logging and visual markers.
- User wants a dual exit system: base system (quick profit capture/Smart Profit Locker) and an overlay to "let winners run" when all trend filters (including new ones) strongly agree. This overlay should only activate in obvious strong trends, preserving high win rate in other conditions.
- CRITICAL REQUIREMENT: Multi-Timeframe ZigZag and trend-riding overlays must use only confirmed/closed bars (no real-time/repainting). All directional bias and exit logic must be based on fully confirmed pivots and bar closes for production reliability.
- Adaptive/impulsive exit system must be fully user-configurable, with UI inputs and clear tooltip explanations for all thresholds (ATR, max loss %, volume, etc.).
- Momentum exit (consecutive adverse bars) now has a separate toggle in the UI, defaulting to OFF, for independent control from impulsive exits. This prevents unwanted early exits and preserves user win rate.
- Critical bug in bias filter logic fixed: disabled filters were being double-counted as both bullish and bearish, breaking confluence logic. Now, only enabled filters vote, and each filter's bias is counted correctly. All bias filters (Hull, SuperTrend, MTF ZigZag, etc.) now function as intended.
- Confluence logic and voting system for directional bias filters completely rewritten. Now only actual votes from enabled filters are counted, and debug output reflects real votes. All bias filters (especially RBW) now have a direct and visible impact on trade entries.
- Major milestone: Bias filters now work and file backed up for safety.
- Critical bug found/fixed: Impulsive exits triggered even when disabled due to logic error (parentheses) – now fixed.
- Trend-Riding mode previously had no impact; now integrated with Smart Profit Locker (3x wider stops, 50% offset) so it can let winners run when active.
- Debug output for trend-riding mode improved to show when it is modifying exits and for how long.
- Next priorities: verify trend-riding overlay and adaptive exit toggles (impulsive/momentum) work as intended and can be enabled/disabled reliably.
- Major design update: "Signal-Driven Trend Rider" replaces price-based exit in trend-riding mode. When active, standard exits are ignored and the system waits for a user-selected opposite signal (from primary indicators) to exit. UI checkboxes allow selection of which signals can trigger the exit, with optional confluence (min signals) requirement.
- Trend-Rider mode must include safety nets: deactivate and exit if trend consensus breaks, max hold duration reached, or a catastrophic stop is hit. All logic must be robust and non-repainting.
- UI must expose signal selection and confluence threshold for trend rider exits (checkboxes and min signals input). Documentation and debug output should clearly reflect this new exit logic.
- User has identified a need for a "hybrid exit mode" in trend-riding: when exit indicators (from a new set of loaded exit/reversal indicators) reach a threshold, instead of exiting immediately, the system should switch from signal-based exit to Smart Profit Locker mode to lock in profits but still allow for further gains. This approach aims to reduce excessive profit giveback while maintaining trend-riding benefits. Options/formulas for this hybrid mode are to be brainstormed and discussed before implementation.
- Plan is now focused on finalizing the strategy and visual/AI integration. All prior development phases (core infra, bias filters, advanced exits, trend rider, bugfixes) have been archived as completed. See memory: EZAlgoTrader Development History - Completed Major Features.
- Next step after strategy finalization: send all plot points and results to an MCP server/AI for automated backtest result analysis and optimization. This is a future pipeline, not required for initial strategy completion.

## Task List - ALL COMPLETED
- [x] Remove all legacy/undeclared variable references and Smart Filter remnants
- [x] Remove legacy trailing stop variable references
- [x] Integrate iLogger with correct initialization and usage
- [x] Confirm logger compiles and logs as intended
- [x] Replace iLogger with native label-based debug system due to array errors
- [x] Remove all remaining references to iLogger and old debug variables
- [x] Gather requirements and brainstorm for directional bias feature
- [x] Specify which indicators to offer for bias (trend, MA ribbon, buy/sell, custom)
- [x] Design confluence logic and checkbox UI for indicator selection
- [x] Plan integration of directional bias into entry/exit logic
- [x] Review and document current trailing stop loss behavior
- [x] Design and implement visual plotting for stop loss levels
- [x] Brainstorm and evaluate additional exit methods or reversal-avoidance ideas
- [x] Stage implementation: requirements → design → code → test
- [x] Remove exit combo backtester (keep multi-signal backtester only)
- [x] Remove all combo backtesting code (multi-signal tables and summary recommendations) for code bloat reduction
- [x] Integrate Relative Bandwidth Filter as a selectable directional bias filter with full option set and compact, multi-column panel UI. Allow independent activation/deactivation.
- [x] Integrate RBW filter output into entry logic for directional bias
- [x] Analyze and document the difference between Smart Stop (current) and Trailing Stop (previous version) logic before making any changes
- [x] Investigate and fix RBW filter logic so it provides directional bias as intended
- [x] Fix missing primary signal logic: combine enabled signals into primaryLongSig/primaryShortSig for entry filtering
- [x] Implement Hull Suite as first modular directional bias filter
- [x] Implement SuperTrend as modular directional bias filter
- [x] Implement Quadrant (Nadaraya-Watson) as modular directional bias filter
- [x] Integrate confluence logic (Any/Majority/All) for enabled filters
- [x] Add UI toggles and parameter inputs for each filter
- [x] Add visual plotting/markers for each bias filter
- [x] Integrate Multi-Timeframe ZigZag as a selectable directional bias filter (confirmed bars only)
- [x] Design and implement trend-riding exit overlay (let winners run when all filters align, fallback to Smart Profit Locker otherwise)
- [x] Implement adaptive/impulsive exit system with user-adjustable thresholds and tooltips
- [x] Add separate toggle for momentum exit (consecutive adverse bars)
- [x] Fix confluence logic and voting system for all bias filters (RBW, Hull, SuperTrend, Quadrant, MTF ZigZag) so only enabled filters vote and debug output shows real votes
- [x] Integrate ZigZag Tails as a selectable directional bias filter
- [x] Verify/fix Trend-Riding overlay integration and debug output
- [x] Verify/fix Adaptive Exit toggles (impulsive/momentum) and ensure correct on/off logic
- [x] Design and implement UI for signal-driven trend rider exit (checkboxes for signals, min signals input)
- [x] Implement signal-driven trend rider exit logic (ignore standard exits, exit on selected opposite signals)
- [x] Implement safety nets for trend rider mode (trend break, catastrophic stop, max hold)
- [x] Test and document signal-driven trend rider system

## STATUS: ARCHIVED - ALL MAJOR DEVELOPMENT COMPLETE
